name: sellers generate, append & check

on:
  workflow_dispatch: {}

jobs:
  sellers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate sellers.new.json (candidate)
        run: |
          mkdir -p data
          python3 tools/sellers_generate.py \
            --system_domain monetizr.com \
            --master data/master_app_ads.txt \
            --publishers data/publishers.csv \
            --partners_dir data/partners \
            --config data/sellers_config.json \
            --out data/sellers.new.json

      - name: Append new sellers into existing data/sellers.json (no removals, bump minor version)
        run: |
          mkdir -p out
          if [ ! -f data/sellers.json ]; then
            echo "ERROR: data/sellers.json not found. Please create an initial version first."
            exit 1
          fi
          python3 tools/sellers_append.py \
            --base data/sellers.json \
            --candidate data/sellers.new.json \
            --out data/sellers.json \
            --summary_dir out

      - name: Validate updated data/sellers.json
        run: |
          python3 tools/sellers_check.py \
            --sellers data/sellers.json \
            --master data/master_app_ads.txt \
            --system_domain monetizr.com

      - name: Show appended summary
        run: |
          if [ -f out/sellers_appended.md ]; then
            echo "================ sellers.json append summary ================"
            cat out/sellers_appended.md
            echo "============================================================="
          else
            echo "No summary file found; probably no changes were appended."
          fi

      - name: Upload sellers artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sellers-json
          path: |
            data/sellers.json
            data/sellers.new.json
            out/sellers_appended.json
            out/sellers_appended.md
